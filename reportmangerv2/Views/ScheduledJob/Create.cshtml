
@model reportmangerv2.ViewModels.CreateJobViewModel
@{
    ViewData["Title"] = "Create Scheduled Job";
}

<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body py-3">
                    <div class="d-flex align-items-center">
                        <div class="icon-shape bg-primary text-white rounded-circle me-3">
                            <i class="fas fa-plus-circle fa-lg"></i>
                        </div>
                        <div>
                            <h4 class="mb-0 text-dark">Create Scheduled Job</h4>
                            <p class="text-muted mb-0">Configure a new automated job with Oracle procedure execution</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1055;">
        <div id="errorToast" class="toast" role="alert">
            <div class="toast-header bg-danger text-white border-0">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong class="me-auto">Error</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="errorMessage"></div>
        </div>
        <div id="successToast" class="toast" role="alert">
            <div class="toast-header bg-success text-white border-0">
                <i class="fas fa-check-circle me-2"></i>
                <strong class="me-auto">Success</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="successMessage"></div>
        </div>
    </div>

    <form id="createJobForm">
        <div class="row">
            <!-- Left Column -->
            <div class="col-lg-8">
                <!-- Basic Information -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white border-0 py-3">
                        <h5 class="mb-0 text-primary"><i class="fas fa-info-circle me-2"></i>Basic Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            @* <div class="col-md-6 mb-3">
                                <label class="form-label fw-semibold">Job Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="Name" name="Name" required placeholder="Enter job name">
                            </div> *@
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-semibold">Schema <span class="text-danger">*</span></label>
                                <select class="form-select" id="SchemaId" name="SchemaId" required asp-items="@ViewBag.Schemas">
                                    <option value="">Select a schema</option>
                                </select>
                            </div>
                            
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Description</label>
                            <textarea class="form-control" id="Description" name="Description" rows="3" placeholder="Enter job description"></textarea>
                        </div>
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="IsActive" checked>
                                <label class="form-check-label fw-semibold" for="IsActive">Active</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Email Configuration -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white border-0 py-3">
                        <h5 class="mb-0 text-primary"><i class="fas fa-envelope me-2"></i>Email Notification</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Email Subject</label>
                            <input type="text" class="form-control" id="MessageSubject" name="MessageSubject" placeholder="Enter email subject">
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Email Body</label>
                            <textarea class="form-control" id="MessageBody" name="MessageBody" rows="4" placeholder="Enter email message body"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Send To (Emails)</label>
                            <input type="text" class="form-control" id="SendToEmails" name="SendToEmails" placeholder="email1@example.com, email2@example.com">
                            <small class="text-muted">Separate multiple emails with commas</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">CC (Emails)</label>
                            <input type="text" class="form-control" id="CCMails" name="CCMails" placeholder="email1@example.com, email2@example.com">
                            <small class="text-muted">Separate multiple emails with commas</small>
                        </div>
                    </div>
                </div>

                <!-- Procedure Configuration -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white border-0 py-3">
                        <h5 class="mb-0 text-primary"><i class="fas fa-database me-2"></i>Procedure Configuration</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Oracle Procedure Name <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="ProcedureName" placeholder="Enter procedure name">
                                <button type="button" class="btn btn-outline-primary" id="loadProcedureBtn">
                                    <i class="fas fa-sync-alt me-1"></i>Load Parameters
                                </button>
                            </div>
                        </div>
                        
                        <div id="parametersSection" style="display: none;">
                            <div class="d-flex align-items-center mb-3">
                                <h6 class="mb-0 text-secondary"><i class="fas fa-cogs me-2"></i>Procedure Parameters</h6>
                            </div>
                            <div id="parametersList"></div>
                        </div>
                    </div>
                </div>
           

                <!-- Schedule Configuration -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white border-0 py-3">
                        <h5 class="mb-0 text-primary"><i class="fas fa-clock me-2"></i>Schedule Configuration</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-2">
                                <label class="form-label fw-semibold">Minute</label>
                                <input type="text" class="form-control cron-part" id="cronMinute" placeholder="*" value="*">
                                <small class="text-muted">0-59</small>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label fw-semibold">Hour</label>
                                <input type="text" class="form-control cron-part" id="cronHour" placeholder="*" value="*">
                                <small class="text-muted">0-23</small>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label fw-semibold">Day</label>
                                <input type="text" class="form-control cron-part" id="cronDay" placeholder="*" value="*">
                                <small class="text-muted">1-31</small>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label fw-semibold">Month</label>
                                <input type="text" class="form-control cron-part" id="cronMonth" placeholder="*" value="*">
                                <small class="text-muted">1-12</small>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label fw-semibold">Day of Week</label>
                                <input type="text" class="form-control cron-part" id="cronDayOfWeek" placeholder="*" value="*">
                                <small class="text-muted">0-7</small>
                            </div>
                        </div>
                        <input type="hidden" id="CronExpression" name="CronExpression" required>
                        <div id="cronDescription" class="mt-3 p-3 bg-light border rounded" style="display: none;">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-calendar-alt text-primary me-2"></i>
                                <strong class="text-dark">Schedule:</strong>
                                <span id="cronText" class="ms-2 text-muted"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column - Actions -->
            <div class="col-lg-4">
                <div class="card border-0 shadow-sm sticky-top" style="top: 20px;">
                    <div class="card-header bg-white border-0 py-3">
                        <h5 class="mb-0 text-primary"><i class="fas fa-tasks me-2"></i>Actions</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-plus-circle me-2"></i>Create Job
                            </button>
                            <a asp-action="Index" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Cancel
                            </a>
                        </div>
                        
                        <hr class="my-4">
                        
                        <div class="text-center">
                            <h6 class="text-muted mb-3">Quick Tips</h6>
                            <div class="text-start">
                                <small class="text-muted d-block mb-2">
                                    <i class="fas fa-lightbulb text-warning me-2"></i>
                                    Use * for any value in cron fields
                                </small>
                                <small class="text-muted d-block mb-2">
                                    <i class="fas fa-lightbulb text-warning me-2"></i>
                                    At least one parameter is required
                                </small>
                                <small class="text-muted d-block">
                                    <i class="fas fa-lightbulb text-warning me-2"></i>
                                    Procedure must exist in selected schema
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<style>
.icon-shape {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.card {
    transition: all 0.3s ease;
}

.card:hover {
    transform: translateY(-2px);
}

.form-control:focus, .form-select:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.parameter-input {
    border-left: 4px solid #0d6efd;
}

.cron-part {
    text-align: center;
    font-weight: 500;
}

.toast {
    min-width: 300px;
}
</style>

@section Scripts {
    <script src="~/lib/cronstrue/dist/cronstrue.min.js"></script>
    <script src="~/js/ScheduledJob/createjob.js"></script>
    @* <script>
        let procedureParameters = [];
        
        // Toast notification functions
        function showErrorToast(message) {
            document.getElementById('errorMessage').textContent = message;
            const toast = new bootstrap.Toast(document.getElementById('errorToast'));
            toast.show();
        }
        
        function showSuccessToast(message) {
            document.getElementById('successMessage').textContent = message;
            const toast = new bootstrap.Toast(document.getElementById('successToast'));
            toast.show();
        }
        
        // Load procedure parameters
        document.getElementById('loadProcedureBtn').addEventListener('click', async function() {
            const schemaId = document.getElementById('SchemaId').value.trim();
            const procedureName = document.getElementById('ProcedureName').value.trim();
            
            if (!schemaId) {
                showErrorToast('Please select a schema first');
                return;
            }
            
            if (!procedureName) {
                showErrorToast('Please enter a procedure name');
                return;
            }
            
            
            try {
                const response = await fetch('/ScheduledJob/GetProcedureParameters', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        procedureName: procedureName,
                        schemaId: schemaId 
                    })
                });
                
                if (response.ok) {
                    const parameters = await response.json();
                    procedureParameters = parameters;
                    displayParameters(parameters);
                    showSuccessToast('Parameters loaded successfully');
                } else {
                    const error = await response.text();
                    showErrorToast('Error loading parameters: ' + error);
                }
            } catch (error) {
                showErrorToast('Error: ' + error.message);
            }
        });
        
        // Display parameters
        function displayParameters(parameters) {
            const parametersList = document.getElementById('parametersList');
            const parametersSection = document.getElementById('parametersSection');
            
            if (parameters.length === 0) {
                parametersList.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>No parameters found for this procedure.</div>';
            } else {
                let html = '<div class="row g-3">';
                parameters.forEach((param, index) => {
                    if (param.direction === 'Input') {
                        html += `
                            <div class="col-md-6">
                                <div class="card border-primary border-opacity-25">
                                    <div class="card-body p-3">
                                        <label class="form-label fw-semibold text-primary">
                                            <i class="fas fa-arrow-right me-1"></i>${param.name}
                                        </label>
                                        <input type="text" class="form-control parameter-input" 
                                               data-index="${index}" 
                                               placeholder="Enter value for ${param.name}">
                                        <small class="text-muted">${param.type} - ${param.direction}</small>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        html += `
                            <div class="col-md-6">
                                <div class="card border-secondary border-opacity-25">
                                    <div class="card-body p-3">
                                        <label class="form-label fw-semibold text-secondary">
                                            <i class="fas fa-arrow-left me-1"></i>${param.name}
                                        </label>
                                        <div class="form-control-plaintext text-muted bg-light rounded p-2">
                                            <i class="fas fa-info-circle me-1"></i>Output parameter - no input required
                                        </div>
                                        <small class="text-muted">${param.type} - ${param.direction}</small>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                });
                html += '</div>';
                parametersList.innerHTML = html;
            }
            
            parametersSection.style.display = 'block';
        }
        
        // Function to build cron expression from individual parts
        function buildCronExpression() {
            const minute = document.getElementById('cronMinute').value || '*';
            const hour = document.getElementById('cronHour').value || '*';
            const day = document.getElementById('cronDay').value || '*';
            const month = document.getElementById('cronMonth').value || '*';
            const dayOfWeek = document.getElementById('cronDayOfWeek').value || '*';

            return `${minute} ${hour} ${day} ${month} ${dayOfWeek}`;
        }
        
        // Function to update cron expression and description
        function updateCronExpression() {
            const cronExpression = buildCronExpression();
            document.getElementById('CronExpression').value = cronExpression;
            
            const cronDescription = document.getElementById('cronDescription');
            const cronText = document.getElementById('cronText');
            
            try {
                const humanReadable = cronstrue.toString(cronExpression, { verbose: true });
                cronText.textContent = humanReadable;
                cronDescription.style.display = 'block';
            } catch (e) {
                cronText.textContent = 'Invalid cron expression';
                cronDescription.style.display = 'block';
                console.log(e)
            }
        }
        
        // Add event listeners to all cron part inputs
        document.querySelectorAll('.cron-part').forEach(input => {
            input.addEventListener('input', updateCronExpression);
        });
        
        // Initialize on page load
        updateCronExpression();
        
        document.getElementById('createJobForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Collect parameter values
            const parameters = [];
            procedureParameters.forEach((param, index) => {
                if (param.direction === 'Input') {
                    const input = document.querySelector(`[data-index="${index}"]`);
                    parameters.push({
                        Name: param.name,
                        Value: input ? input.value : null,
                        Type: param.type,
                        Direction: param.direction
                    });
                } else {
                    // Include output parameters without values
                    parameters.push({
                        Name: param.name,
                        Value: null,
                        Type: param.type,
                        Direction: param.direction
                    });
                }
            });
            
            const formData = {
                Name: document.getElementById('Name').value,
                Description: document.getElementById('Description').value,
                SchemaId: document.getElementById('SchemaId').value,
                ProcedureName: document.getElementById('ProcedureName').value,
                CronExpression: document.getElementById('CronExpression').value,
                Parameters: parameters
            };
            
            try {
                const response = await fetch('/ScheduledJob/CreateScheduledJob', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    showSuccessToast('Job created successfully');
                    setTimeout(() => {
                        window.location.href = '/Job';
                    }, 1500);
                } else {
                    const error = await response.text();
                    showErrorToast('Error: ' + error);
                }
            } catch (error) {
                showErrorToast('Error: ' + error.message);
            }
        }); *@
    </script>
}