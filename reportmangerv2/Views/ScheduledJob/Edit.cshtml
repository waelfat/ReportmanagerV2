@model EditScheduledJobViewModel
@{
    ViewData["Title"] = "Edit Scheduled Job";
}

<div class="container">
    <h2>Edit Scheduled Job</h2>
    
    <!-- Toast Container -->
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1055;">
        <div id="errorToast" class="toast" role="alert">
            <div class="toast-header bg-danger text-white border-0">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong class="me-auto">Error</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="errorMessage"></div>
        </div>
        <div id="successToast" class="toast" role="alert">
            <div class="toast-header bg-success text-white border-0">
                <i class="fas fa-check-circle me-2"></i>
                <strong class="me-auto">Success</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="successMessage"></div>
        </div>
    </div>
    <form id="editJobForm">
        <input type="hidden" id="JobId" value="@Model.Id">
        
    
        
        <div class="form-group">
            <label for="Description">Description</label>
            <textarea class="form-control" id="Description" name="Description" rows="3">@Model.Description</textarea>
        </div>
        
        <div class="form-group">
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="IsActive" @(Model.IsActive ? "checked" : "")>
                <label class="form-check-label fw-semibold" for="IsActive">Active</label>
            </div>
        </div>
        
        <h4 class="mt-4">Email Notification</h4>
        
        <div class="form-group">
            <label for="MessageSubject">Email Subject</label>
            <input type="text" class="form-control" id="MessageSubject" name="MessageSubject" value="@Model.MessageSubject" placeholder="Enter email subject">
        </div>
        
        <div class="form-group">
            <label for="MessageBody">Email Body</label>
            <textarea class="form-control" id="MessageBody" name="MessageBody" rows="4" placeholder="Enter email message body">@Model.MessageBody</textarea>
        </div>
        
        <div class="form-group">
            <label for="SendToEmails">Send To (Emails)</label>
            <input type="text" class="form-control" id="SendToEmails" name="SendToEmails" value="@Model.SendToEmails" placeholder="email1@example.com, email2@example.com">
            <small class="text-muted">Separate multiple emails with commas</small>
        </div>
        
        <div class="form-group">
            <label for="CCMails">CC (Emails)</label>
            <input type="text" class="form-control" id="CCMails" name="CCMails" value="@Model.CCMails" placeholder="email1@example.com, email2@example.com">
            <small class="text-muted">Separate multiple emails with commas</small>
        </div>
        
        <div class="form-group">
            <label for="SchemaId">Schema</label>
            <select class="form-control" id="SchemaId" name="SchemaId" required>
                @if (ViewBag.Schemas != null)
                {
                    @foreach (var schema in ViewBag.Schemas as IEnumerable<SelectListItem>)
                    {
                        @if (schema.Value == Model.SchemaId)
                        {
                            <option value="@schema.Value" selected>@schema.Text</option>
                        }
                        else
                        {
                            <option value="@schema.Value">@schema.Text</option>
                        }
                    }
                }
            </select>
        </div>
        
        <div class="form-group">
            <label for="ProcedureName">Oracle Procedure Name</label>
            <div class="input-group">
                <input type="text" class="form-control" id="ProcedureName" value="@Model.ProcedureName" placeholder="Enter procedure name">
                <div class="input-group-append">
                    <button type="button" class="btn btn-info" id="loadProcedureBtn">Reload Parameters</button>
                </div>
            </div>
        </div>
        
        <div id="parametersSection">
            <h4>Procedure Parameters</h4>
            <div id="parametersList">
                <div class="row g-3">
                    @foreach (var param in Model.Parameters)
                    {
                        if (param.Direction == "Input")
                        {
                            <div class="col-md-6">
                                <div class="card border-primary border-opacity-25">
                                    <div class="card-body p-3">
                                        <label class="form-label fw-semibold text-primary">
                                            <i class="fas fa-arrow-right me-1"></i>@param.Name
                                        </label>
                                        <input type="text" class="form-control parameter-input" 
                                               data-name="@param.Name" 
                                               data-type="@param.Type"
                                               data-direction="@param.Direction"
                                               value="@param.Value"
                                               placeholder="Enter value for @param.Name">
                                        <small class="text-muted">@param.Type - @param.Direction</small>
                                    </div>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="col-md-6">
                                <div class="card border-secondary border-opacity-25">
                                    <div class="card-body p-3">
                                        <label class="form-label fw-semibold text-secondary">
                                            <i class="fas fa-arrow-left me-1"></i>@param.Name
                                        </label>
                                        <div class="form-control-plaintext text-muted bg-light rounded p-2">
                                            <i class="fas fa-info-circle me-1"></i>Output parameter - no input required
                                        </div>
                                        <small class="text-muted">@param.Type - @param.Direction</small>
                                        <input type="hidden" class="parameter-output" 
                                               data-name="@param.Name" 
                                               data-type="@param.Type"
                                               data-direction="@param.Direction">
                                    </div>
                                </div>
                            </div>
                        }
                    }
                </div>
            </div>
        </div>
        
        <div class="form-group">
            <label>Cron Expression Builder</label>
            <div class="row">
                <div class="col-md-2">
                    <label for="cronMinute">Minute (0-59)</label>
                    <input type="text" class="form-control cron-part" id="cronMinute" placeholder="*">
                </div>
                <div class="col-md-2">
                    <label for="cronHour">Hour (0-23)</label>
                    <input type="text" class="form-control cron-part" id="cronHour" placeholder="*">
                </div>
                <div class="col-md-2">
                    <label for="cronDay">Day (1-31)</label>
                    <input type="text" class="form-control cron-part" id="cronDay" placeholder="*">
                </div>
                <div class="col-md-2">
                    <label for="cronMonth">Month (1-12)</label>
                    <input type="text" class="form-control cron-part" id="cronMonth" placeholder="*">
                </div>
                <div class="col-md-2">
                    <label for="cronDayOfWeek">Day of Week (0-7)</label>
                    <input type="text" class="form-control cron-part" id="cronDayOfWeek" placeholder="*">
                </div>
            </div>
            <input type="hidden" id="CronExpression" name="CronExpression" required>
            <small class="form-text text-muted">Use * for any value, numbers for specific values, or ranges like 1-5</small>
            <div id="cronDescription" class="mt-2 p-2 bg-light border rounded" style="display: none;">
                <strong>Schedule:</strong> <span id="cronText"></span>
            </div>
        </div>
        
        <div class="form-group">
            <button type="submit" class="btn btn-primary">Update Job</button>
            <a asp-action="Index" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

@section Scripts {
    <script src="~/lib/cronstrue/dist/cronstrue.min.js"></script>
    <script src="~/js/ScheduledJob/editjob.js"></script>
    <script>
        // Initialize with existing data
        const existingParameters = [
            @foreach (var param in Model.Parameters)
            {
                <text>{
                    name: '@param.Name',
                    type: '@param.Type',
                    direction: '@param.Direction'
                },</text>
            }
        ];
        
        initializeEditJob('@Model.CronExpression', existingParameters);
    </script>
}